function iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}function getKeyByValue(e,t){return Object.keys(e).find((n=>e[n]===t))}function findNextValueByValue(e,t){var n=Object.keys(t);return t[n[(n.indexOf(getKeyByValue(t,e))+1)%n.length]]}function memcpy(e,t,n,a,o){var r;if(e=e.subarray||e.slice?e:e.buffer,n=n.subarray||n.slice?n:n.buffer,e=t?e.subarray?e.subarray(t,o&&t+o):e.slice(t,o&&t+o):e,n.set)n.set(e,a);else for(r=0;r<e.length;r++)n[r+a]=e[r];return n}$fx.params([{id:"pigments_id",name:"Pigments",type:"select",options:{options:["horizon, sunshine, grapefruit","night, embers, citrus","ivy, apatite, tourmaline","sodalite, glacier, rust","ocean, lapis, sulphur","moss, cedar, algae","ink, steel, salt","charcoal, papyrus, marble","murex, rhodochrosite, marshmallow","furnace, ruby, soot"]}},{id:"pattern_id",name:"Pattern",type:"select",options:{options:["noisy","graded","layered","stacked","composed"]}},{id:"dimension_id",name:"Dimension",type:"select",options:{options:["pin","stick","needle","wire"]}},{id:"noise_feature_id",name:"Structure",type:"select",options:{options:["cracks","bands","sheets","unbiased"]}},{id:"noise_form_id",name:"Form",type:"select",default:"expressive",options:{options:["expressive","monolithic"]}},{id:"noise_cull_id",name:"Dissipation",type:"select",options:{options:["clean","fuzzy"]}},{id:"attachment_id",name:"Attachment",type:"select",default:"tight",options:{options:["dense","tight","detached","loose","floating"]}},{id:"explosion_id",name:"Exploded",type:"boolean",default:!1},{id:"power_id",name:"Power",type:"number",default:2,options:{min:0,max:5,step:.1}},{id:"coordinates_id",name:"Coordinates",type:"string",options:{minLength:64,maxLength:64}}]),gene=$fx.rand;var noise_coordinates=$fx.getParam("coordinates_id"),seeded_gene=new Math.seedrandom(noise_coordinates);function generateRandomInt(e,t){return Math.floor(gene()*(t-e)+e)}function gene_range(e,t){return gene()*(t-e)+e}function gene_range_seeded(e,t){return seeded_gene()*(t-e)+e}function gene_pick_n(e,t,n){for(var a=[],o=0;o<n;o++)a.push(Math.floor(gene()*(t-e)+e));return a}function gene_weighted_choice(e){let t=0;for(let n=0;n<e.length;++n)t+=e[n][1];const n=gene()*t;t=0;for(let a=0;a<e.length-1;++a)if(t+=e[a][1],t>=n)return e[a][0];return e[e.length-1][0]}function gene_weighted_choice_seeded(e){let t=0;for(let n=0;n<e.length;++n)t+=e[n][1];const n=seeded_gene()*t;t=0;for(let a=0;a<e.length-1;++a)if(t+=e[a][1],t>=n)return e[a][0];return e[e.length-1][0]}function gene_pick_key(e){var t=Object.keys(e);return t[t.length*gene()<<0]}function gene_pick_property(e){var t=Object.keys(e);return e[t[t.length*gene()<<0]]}function calculate_size(e,t){return 0==e?50*gene()+25:1==e?t.connectivity/5*50+25:2==e?50*in_case_of_common_size+25:3==e?50*gene()+25:void 0}function sigmoid(e,t){return 1/(1+Math.exp(-e/t))}function createCircleTexture(e,t){var n=document.createElement("canvas");n.width=n.height=t;var a=n.getContext("2d"),o=new THREE.Texture(n),r=t/2;return a.beginPath(),a.arc(r,r,t/2,0,2*Math.PI,!1),a.closePath(),a.fillStyle=e,a.fill(),o.needsUpdate=!0,o}function gaussian(e,t){var n,a=!1;return function(){var o;if(a)o=n,a=!1;else{var r,i,s;do{s=(r=2*gene()-1)*r+(i=2*gene()-1)*i}while(s>=1);o=r*(s=Math.sqrt(-2*Math.log(s)/s)),n=i*s,a=!0}var c=e+t*o;return c>0?c:-c}}function lerp(e,t,n){return(1-n)*e+n*t}function shuffleArray(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(gene()*(t+1)),a=e[t];e[t]=e[n],e[n]=a}}function shiftArray(e){let t=e.pop();return e.unshift(t),e}function shiftArrayCopy(e){arrCopy=[...e];let t=arrCopy.pop();return arrCopy.unshift(t),arrCopy}var cam_factor_mod,dynamic_track=!1,linewidth_scale=1e-5,loading_start_time=(new Date).getTime(),min_loading_time=1e3,debug=!0,cam_factor=4,aspect_ratio="0.5625",global_rot_x=-Math.PI/16,global_rot_y=Math.PI/16;const light_frame_speed_param={Fast:25,Normal:50,Slow:500,SuperSlow:1e3},light_step_size_param={Paused:0,DaySync:72e-6,SuperSmall:25e-5,Small:5e-4,Medium:.001,Large:.0015};var random_starfield_bounds=1e3,nr_of_random_stars=15e3;const flickerInterval=100,flickerDuration=2e3,cycleDuration=5e3,cycleBackground=1e6,cycleBackgroundUpdate=100,rotThetaDelta=2*Math.PI*100/1e6,rotVectorBackground=new THREE.Vector3(0,0,1),rotMatrixStaticIncrement=new THREE.Matrix4;rotMatrixStaticIncrement.makeRotationAxis(rotVectorBackground,rotThetaDelta);const palette_pigments={"horizon, sunshine, grapefruit":{Otti:["#a3d3ff","#fefaee","#ff855f","#ffe550"],"Stölzl":["#c44414","#daa211","#255080","#e7e7d7"],Albers:["#f9f0df","#e51335","#2a72ae","#fbb515"],Brandt:["#3bb3ff","#feeddd","#ffbb33","#ff2244"],"Koch-Otte":["#ee5626","#eebb22","#4d9db9","#f5f5d5","#7cc1c1"],Arndt:["#e22e82","#efbf33","#3555a5","#e7e7d7"],"Siedhoff-Buscher":["#ebb707","#e84818","#266396","#eecece","#e4e4e4"],Heymann:["#ee2f2f","#f2cd22","#1b94bb","#faaaba","#feeede"]},"night, embers, citrus":{"van der Rohe":["#f34333","#fdd666","#275777","#f3f3f3","#090909"],Breuer:["#ffbf0b","#ee3e6e","#2277a7","#f9f0df","#090909"],Gropius:["#f9f0df","#e51335","#2a72ae","#fbb515","#090909"],"Le Corbusier":["#f24222","#fccc0c","#4888c8","#f9f0df","#090909"]},"ivy, apatite, tourmaline":{"O'Keeffe":["#0e4a4e","#ff9777","#ead2a2","#5484a8"],"Dalí":["#e54545","#f77757","#fccc66","#fafa66","#1ac1ca"],Matisse:["#06add6","#066888","#f0cc0c","#fff1d1","#dd1d1d"],Kandinsky:["#ffbf0b","#ee3e6e","#2277a7","#33936d","#f9f0df"],Chagall:["#f6af06","#1e66aa","#eee7d7","#019166","#e74422"],Negreiros:["#f8c8de","#f2e222","#28b2d2","#668833","#ef6e7e","#f2f2e2"],Picasso:["#f33373","#eed333","#445e7e","#19a199","#ede8dd"],Klee:["#de3e1e","#de9333","#007555","#eccdad","#889979","#7aa7a7"]},"sodalite, glacier, rust":{Planck:["#f8f8e8","#d83818","#224772","#151a1a"],Thomson:["#144b5b","#088191","#e5fde5","#466994","#f55b66"],Einstein:["#ebe0ce","#c5c5bb","#242d44","#e4042e"],Heisenberg:["#f9f9f0","#e11e21","#e7007e","#005aa5","#5ec5ee"],Bohr:["#f999a9","#044499","#1a88c1","#77aee7","#a6d6d6","#f9f9f0"],Feynman:["#004999","#557baa","#ff4f44","#ffbcbc","#fff8e8"],Dirac:["#db4545","#d0e0e0","#3a6a93","#2e3855","#a3c6d3"]},"ocean, lapis, sulphur":{Babbage:["#1a3daa","#244888","#2277d7","#62aad6","#f2d552"],Lovelace:["#dafaff","#00bbfb","#005995","#002044"],Leibniz:["#fff8f8","#a3e3dd","#1c6dd6","#2c2c44","#ffd525"],Boole:["#070c0c","#1d5581","#fece3c","#f8e288","#9fc999"]},"moss, cedar, algae":{Zancan:["#445522","#788c33","#b5be5e","#242414","#f2f2f2"],Muir:["#cec09c","#505e3e","#374727","#2a3322"],Thoreau:["#144b5b","#1a966a","#88d899","#cadaba","#f9e9d9"]},"ink, steel, salt":{Hokusai:["#7d9aa7","#c0b8a8","#ddd4c4","#10244a","#444b4e"],Hiroshige:["#ebe0ce","#20335c","#1c2244","#1d1f2d"]},"charcoal, papyrus, marble":{Charcoal:["#090909","#1a1a1a","#1d1d1d","#222222","#2c2c2c","#3c3c3c"],Marble:["#cac5b5","#ebe0ce","#f9f0df","#eee7d7","#fff8f8","#feeddd"],Adams:["#ebe0ce","#2a2b2c","#1e1e1e"],"New York Times":["#ebe0ce","#cac5b5","#1e1e1e"]},"murex, rhodochrosite, marshmallow":{Minsky:["#c5e5f5","#fd5d9d","#fccce0","#feefef"],Newell:["#8d00d8","#d722b7","#f288c2","#f9c66c","#e2e2e2"],Simon:["#1f336f","#553773","#8b3b7b","#f7447f","#f9f0df"],McCarthy:["#3fb3aa","#7cc7ac","#dadaaa","#fe9e9e","#ff3f7f"],Solomonoff:["#e77e99","#6cc6dd","#866686","#f9f9f0"],Shannon:["#665d8d","#7799aa","#d885a5","#fccebb"],"von Neumann":["#4a0020","#550533","#750555","#990f5f","#f9f0df"],Turing:["#e40422","#e33388","#434394","#191919","#ece3d3"]},"furnace, ruby, soot":{Kapoor:["#900f3f","#c70033","#ff5333","#ffcc00","#f9f0df"],Golid:["#fece44","#ede8dd","#ff5333","#ff99b9"],Busia:["#f9f0df","#e51335","#090909"],Judd:["#e51335","#e4042e","#d83818","#ff2244","#e74422","#e11e21","#faaf0f","#fbb515","#ff855f","#191919"],Malevich:["#ece3d3","#e51335","#1d1d1d","#fcc1c1"]}},allel_color_features_vert=[["none",80],["vertical stripe sparse",5],["vertical stripe dashed",5],["vertical stripe blocks",5],["vertical stripe solid",5]],allel_color_features_horiz=[["none",85],["horizontal stripe dashed",5],["horizontal stripe blocks",5],["horizontal stripe solid",5]],allel_noise_scale_x=[[.05,2],[.1,1],[.15,1],[.2,1]],allel_noise_scale_y=[[.1,1],[.2,1],[.3,1],[.4,1],[.5,1]],allel_noise_scale_z=[[.1,1],[.2,1],[.3,1],[.4,1],[.5,1]],allel_color_gradient_quadrants=[["solid sprinkled",1],["uniform",1],["vertical grading",1],["horizontal grading",1],["width stack",1],["height stack",1],["depth stack",1]],allel_quadrant_div=[[1.5,1],[1.75,1],[2,1],[3,1],[4,1]],dimensions={voxel:["square 1x1",5,5,115,190,30],pin:["square beam",5,25,115,37,30],stick:["square beam",5,50,115,20,30],needle:["square beam",2.5,75,220,15,30],wire:["square beam",2.5,100,110,11,30]},attachment_values={dense:0,tight:1,detached:10,loose:25,floating:50},cylinder_params={standard:[.5,.5,1,6,1],"square beam":[.5,.5,1,4,1],"square 1x1":[.7,.7,1,4,1]};var pigments=$fx.getParam("pigments_id"),palette_name=gene_pick_key(palette_pigments[pigments]),chosen_palette=palette_pigments[pigments][palette_name].slice(0);shuffleArray(chosen_palette);var pattern=$fx.getParam("pattern_id");if("noisy"==pattern)var color_gradient_default="uniform";if("graded"==pattern)color_gradient_default=gene()<.5?"vertical grading":"horizontal grading";if("layered"==pattern)color_gradient_default=gene()<.5?"solid sprinkled":"depth stack";if("stacked"==pattern)color_gradient_default="height stack";if("composed"==pattern)color_gradient_default="solid sprinkled";var quadrants="composed"==pattern,quadrant_div_x=gene_weighted_choice(allel_quadrant_div),quadrant_div_y=gene_weighted_choice(allel_quadrant_div),color_gradient_quadrants=[gene_weighted_choice(allel_color_gradient_quadrants),gene_weighted_choice(allel_color_gradient_quadrants),gene_weighted_choice(allel_color_gradient_quadrants),gene_weighted_choice(allel_color_gradient_quadrants)],noise_feature=$fx.getParam("noise_feature_id"),noise_form=$fx.getParam("noise_form_id"),noise_form_scales="expressive"==noise_form?[1,1]:[.1,.25],noise_cull_rule=$fx.getParam("noise_cull_id"),dimension_type=$fx.getParam("dimension_id"),jitter_reduction="voxel"==dimension_type||"needle"==dimension_type?.5:1;"wire"==dimension_type&&(jitter_reduction=.75);var attachment_type=$fx.getParam("attachment_id"),exploded=$fx.getParam("explosion_id"),explosion_power=$fx.getParam("power_id"),c_type=dimensions[dimension_type][0],c_xy_scale=dimensions[dimension_type][1],c_length=dimensions[dimension_type][2],grid_nr_x=dimensions[dimension_type][3],grid_nr_y=dimensions[dimension_type][4],grid_nr_z=dimensions[dimension_type][5],y_gap=attachment_values[attachment_type],x_gap="wire"==dimension_type?3:0;if("stick"==dimension_type)var extra_offset=12;else if("needle"==dimension_type||"wire"==dimension_type)extra_offset=-10;else extra_offset=0;var noise_scale_x,noise_scale_y,noise_scale_z,grid_offset_x=-grid_nr_x*(c_xy_scale+x_gap)/2,grid_offset_y=extra_offset-grid_nr_y*(c_length+y_gap)/2,grid_offset_z=-grid_nr_z*(c_xy_scale+x_gap)/2,total_elements_existing=0,total_possible_elements=grid_nr_x*grid_nr_y*grid_nr_z,color_features_vert=gene_weighted_choice(allel_color_features_vert),color_features_horiz=gene_weighted_choice(allel_color_features_horiz),color_features=[color_features_vert,color_features_horiz],stripe_param_a=Math.floor(gene_range(2,20)),stripe_param_b=Math.floor(gene_range(2,20)),stripe_param_c=Math.floor(gene_range(2,20)),stripe_width=Math.floor(gene_range(2,20)),stripe_spacing=Math.floor(gene_range(5,15)),stripe_shift=Math.floor(gene_range(1,stripe_spacing)),block_spacing=Math.floor(gene_range(50,150)),block_width=Math.floor(block_spacing/2),shift_sign_horiz=gene()<.5?1:-1,shift_sign_vert=-shift_sign_horiz,noise_height_f=c_length/c_xy_scale;"cracks"==noise_feature?(noise_scale_x=gene_weighted_choice_seeded(allel_noise_scale_x)*noise_form_scales[1],noise_scale_y=.01*noise_form_scales[0],noise_scale_z=.025):"bands"==noise_feature?(noise_scale_x=.01*noise_form_scales[0],noise_scale_y=gene_weighted_choice_seeded(allel_noise_scale_y),noise_scale_z=.05*noise_form_scales[0]):"sheets"==noise_feature?(noise_scale_x=.01*noise_form_scales[0],noise_scale_y=.01*noise_form_scales[0],noise_scale_z=gene_weighted_choice_seeded(allel_noise_scale_z)):(noise_scale_x=.01*noise_form_scales[0],noise_scale_y=.01*noise_form_scales[0],noise_scale_z="clean"==noise_cull_rule?.05:.01);var noise_shift_x=gene_range_seeded(-100,100),noise_shift_y=gene_range_seeded(-100,100),noise_shift_z=gene_range_seeded(-100,100),explosion_center_a=new THREE.Vector3(gene_range(-200,200),gene_range(-200,200),0),explosion_strength=2e5*explosion_power,explosion_rot_range=Math.PI/2,explosion_rot_factor=.1;console.log("%cCOLOR","color: white; background: #000000;"),console.log("palette ->",palette_name,"\n"),console.log("%c    %c    %c    %c    %c    %c    %c    %c    %c    %c    %c    %c    %c    %c    %c    ",`color: white; background: ${chosen_palette[0]};`,`color: white; background: ${chosen_palette[1]};`,`color: white; background: ${chosen_palette[2]};`,`color: white; background: ${chosen_palette[3]};`,`color: white; background: ${chosen_palette[4]};`,`color: white; background: ${chosen_palette[5]};`,`color: white; background: ${chosen_palette[6]};`,`color: white; background: ${chosen_palette[7]};`,`color: white; background: ${chosen_palette[8]};`,`color: white; background: ${chosen_palette[9]};`,`color: white; background: ${chosen_palette[10]};`,`color: white; background: ${chosen_palette[11]};`,`color: white; background: ${chosen_palette[12]};`,`color: white; background: ${chosen_palette[13]};`,`color: white; background: ${chosen_palette[14]};`),console.log("color gradient default ->",color_gradient_default),console.log("quadrants ->",quadrants),console.log("color grading quadrants ->",color_gradient_quadrants),console.log("quadrant divs ->",`(${quadrant_div_x}, ${quadrant_div_y})`),console.log("%cNOISE CULL","color: white; background: #000000;"),console.log("noise cull rule ->",noise_cull_rule),console.log("noise feature ->",noise_feature),console.log("noise scale x ->",noise_scale_x),console.log("noise scale y ->",noise_scale_y),console.log("noise scale z ->",noise_scale_z),console.log("%cSTRIPES","color: white; background: #000000;"),console.log("color features vert ->",color_features_vert),console.log("color features horiz ->",color_features_horiz),console.log("stripe width ->",stripe_width),console.log("stripe spacing ->",stripe_spacing),console.log("stripe shift ->",stripe_shift),console.log("block spacing ->",block_spacing),console.log("block width ->",block_width);const loader_element_dim={voxel:[10,10],pin:[5,25],stick:[5,50],needle:[2,50],wire:[2,100]},canvasWidth=400,canvasHeight=100,x_step=loader_element_dim[dimension_type][0],y_step=loader_element_dim[dimension_type][1],offset_x=x_step/2,offset_y=y_step/2,nr_in_width=Math.floor(400/x_step),nr_in_height=Math.floor(100/y_step);function setup(){createCanvas(400,100).parent("p5loader"),frameRate(10)}function draw(){background(chosen_palette[0]),rectMode(CENTER),strokeWeight(1),noStroke();for(var e=0;e<nr_in_width;e++)for(var t=0;t<nr_in_height;t++){for(var n=[e,nr_in_width-e,5,5,5,5,5,5,5,5,5],a=[],o=0;o<chosen_palette.length;o++)a.push([chosen_palette[o],n[o]]);var r=gene_weighted_choice(a);fill(r),rect(offset_x+e*x_step,offset_y+t*y_step,x_step,y_step)}}var dense_matter_memory={},dense_matter_object={},elements_per_palette_object={},imesh_index_tracker={},imeshes_object={},animation_frametime=0,gif_frame_n=10,explosion_state_t=null,palette_state_t=null;const animation_time=5,animation_increment=.25;$fx.features({Pigments:pigments,Palette:palette_name,Pattern:pattern,Dimension:dimension_type,Structure:noise_feature,Form:noise_form,Dissipation:noise_cull_rule,Attachment:attachment_type,Exploded:exploded}),console.log("%cTOKEN FEATURES","color: white; background: #000000;","\n","Pigments -> "+pigments,"\n","Palette -> "+palette_name,"\n","Pattern -> "+pattern,"\n","Dimension -> "+dimension_type,"\n","Structure -> "+noise_feature,"\n","Form -> "+noise_form,"\n","Dissipation -> "+noise_cull_rule,"\n","Attachment -> "+attachment_type,"\n","Exploded -> "+exploded,"\n");var viewportHeight,viewportWidth,light_framerate_change,base_light_angle_step,light_angle,controller,pre_calc=0,viz_update=0,composer_pass=0,viewport=document.getElementById("viewport"),margin_left=0,margin_top=0,background_toggle=!1,renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,preserveDrawingBuffer:!0});const composer=new THREE.EffectComposer(renderer);let snap=!1,quality=0;var capturer=null;let recording=!1;function View(e){window.innerWidth/aspect_ratio>window.innerHeight?(viewportHeight=window.innerHeight,viewportWidth=aspect_ratio*window.innerHeight,margin_top=0,margin_left=(window.innerWidth-viewportWidth)/2):(viewportHeight=window.innerWidth/aspect_ratio,viewportWidth=window.innerWidth,margin_top=(window.innerHeight-viewportHeight)/2,margin_left=0),viewport.style.marginTop=margin_top+"px",viewport.style.marginLeft=margin_left+"px",cam_factor_mod=cam_factor*Math.min(viewportWidth/1e3,viewportHeight/1e3),renderer.setSize(viewportWidth,viewportHeight),renderer.shadowMap.enabled=!0,renderer.domElement.id="obscvrvmcanvas",viewport.appendChild(renderer.domElement);var t=new THREE.Scene,n=new THREE.OrthographicCamera(-viewportWidth/cam_factor_mod,viewportWidth/cam_factor_mod,viewportHeight/cam_factor_mod,-viewportHeight/cam_factor_mod,0,5e3);n.position.set(0,0,2e3),n.lookAt(new THREE.Vector3(0,0,0)),composer.setSize(window.innerWidth,window.innerHeight),t.background=new THREE.Color("#080808");var a=new THREE.DirectionalLight(16777215,.9);a.position.set(2e3,2e3,750),a.castShadow=!0,a.shadow.camera.near=1e3,a.shadow.camera.far=3500,a.shadow.bias=-222e-6;const o=1e3;a.shadow.camera.left=-o,a.shadow.camera.right=o,a.shadow.camera.top=o,a.shadow.camera.bottom=-o;var r=8192,i=!1;try{const e=window.location.search,t=new URLSearchParams(e),n=t.get("shadow");try{const e=t.get("explosion");null!=e&&(explosion_state_t=Math.abs(parseFloat(e)))}catch(e){}try{const e=t.get("palette");null!=e&&(palette_state_t=Math.abs(parseInt(e)))}catch(e){}try{const e=t.get("gif");null!=e&&(gif_frame_n=Math.abs(parseInt(e)))}catch(e){}null!=n&&(r=Math.abs(parseInt(n)),i=!0)}catch(e){}Number.isInteger(r)&i?(console.log("Using custom url parmater for shadow map size: "+r.toString()),a.shadow.mapSize.width=r,a.shadow.mapSize.height=r):Number.isInteger(r)&iOS()?(a.shadow.mapSize.width=Math.min(r,2048),a.shadow.mapSize.height=Math.min(r,2048)):Number.isInteger(r)&!iOS()?(a.shadow.mapSize.width=Math.max(r,4096),a.shadow.mapSize.height=Math.max(r,4096)):(a.shadow.mapSize.width=4096,a.shadow.mapSize.height=4096),t.add(a);const s=new THREE.AmbientLight(16777215,.1);t.add(s),this.winHeight=viewportHeight,this.winWidth=viewportWidth,this.scale=1,this.scene=t,this.camera=n,this.composer=composer,this.light=a,this.renderer=renderer,this.wire=null,this.lines=null,this.meshline_data=[],this.meshline_mesh=[],this.curves=[];const c=new THREE.RenderPass(this.scene,this.camera);this.composer.addPass(c),effectFXAA=new THREE.ShaderPass(THREE.FXAAShader),effectFXAA.uniforms.resolution.value.x=1/(window.innerWidth*window.devicePixelRatio),effectFXAA.uniforms.resolution.value.y=1/(window.innerHeight*window.devicePixelRatio),this.composer.addPass(effectFXAA);const l=new THREE.UnrealBloomPass;l.strength=.3,l.radius=0,l.threshold=0,this.composer.addPass(l)}function Controller(e){var t=new View(e);t.cam_distance=700,this.view=t,t.addDenseMatter(),t.addStarsRandom(random_starfield_bounds,nr_of_random_stars),t.addStarDust(),t.addMoon(),t.preRender();var n=(new Date).getTime()-loading_start_time;if(n>min_loading_time){for(i=0;i<21;i++){let e=i;setTimeout((function(){document.querySelector("#loading").style.opacity=1-.05*e}),100*e)}setTimeout((function(){document.querySelector("#loading").style.display="none"}),2e3),t.render()}else{for(i=0;i<21;i++){let e=i;setTimeout((function(){document.querySelector("#loading").style.opacity=1-.05*e}),min_loading_time-n+100*e)}setTimeout((function(){document.querySelector("#loading").style.display="none"}),min_loading_time-n+2e3),t.render()}setTimeout((function(){$fx.preview()}),min_loading_time+3e3),window.addEventListener("resize",(function(){viewportAdjust(document.getElementById("viewport"),!1),fitCameraToViewport(t,viewportWidth,viewportHeight)}));const a=new THREE.Raycaster,o=new THREE.Vector2;window.addEventListener("click",(function(e){o.x=e.clientX/window.innerWidth*2-1,o.y=-e.clientY/window.innerHeight*2+1;const n=a.intersectObjects(t.scene.children);for(let e=0;e<n.length;e++){n[e].point.z=0,console.log(n[e].point),View.prototype.DenseMatterCreateExplosionVectors(n[e].point);break}animation_frametime=0}))}function obscvrvm(){controller=new Controller("viewport")}function viewportAdjust(e,t=!0){t?(window.innerWidth/aspect_ratio>window.innerHeight?(viewportHeight=window.innerHeight,viewportWidth=aspect_ratio*window.innerHeight,margin_top=0,margin_left=(window.innerWidth-viewportWidth)/2):(viewportHeight=window.innerWidth/aspect_ratio,viewportWidth=window.innerWidth,margin_top=(window.innerHeight-viewportHeight)/2,margin_left=0),cam_factor_mod=cam_factor*Math.min(viewportWidth/1e3*quality,viewportHeight/1e3*quality)):(window.innerWidth/aspect_ratio>window.innerHeight?(viewportHeight=window.innerHeight,viewportWidth=aspect_ratio*window.innerHeight,margin_top=0,margin_left=(window.innerWidth-viewportWidth)/2):(viewportHeight=window.innerWidth/aspect_ratio,viewportWidth=window.innerWidth,margin_top=(window.innerHeight-viewportHeight)/2,margin_left=0),cam_factor_mod=cam_factor*Math.min(viewportWidth/1e3,viewportHeight/1e3)),e.style.marginTop=margin_top+"px",e.style.marginLeft=margin_left+"px"}function fitCameraToViewport(e,t,n,a=!0){e.renderer.setSize(t,n),e.composer.setSize(t,n),a&&(e.camera.left=-t/cam_factor_mod,e.camera.right=t/cam_factor_mod,e.camera.top=n/cam_factor_mod,e.camera.bottom=-n/cam_factor_mod),e.camera.updateProjectionMatrix()}function capturer_custom_save(){setTimeout((()=>{capturer.save((function(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`tectonica_${parseInt(1e7*Math.random())}.gif`,n.click(),URL.revokeObjectURL(t)})),setTimeout((()=>{capturer=null}),250)}),0)}function check_drawing_buffer(e){var t=e*Math.max(viewportWidth,viewportHeight);if(t>5500){var n=5500*e/t;return console.log("Browser drawing buffer exceed. Reverting to the following quality multiplier: "+n.toFixed(2).toString()),n}return e}function doc_keyUp(e){if(49===e.keyCode||97===e.keyCode)snap=!0,quality=1;else if(50===e.keyCode||98===e.keyCode)snap=!0,quality=check_drawing_buffer(2);else if(51===e.keyCode||99===e.keyCode)snap=!0,quality=check_drawing_buffer(3);else if(52===e.keyCode||100===e.keyCode)snap=!0,quality=check_drawing_buffer(4);else if(53===e.keyCode||101===e.keyCode)snap=!0,quality=check_drawing_buffer(5);else if(71===e.keyCode)recording=!recording,recording?((capturer=new CCapture({verbose:!1,display:!1,framerate:gif_frame_n,format:"gif",workersPath:"js/capture/src/"})).start(),setTimeout((()=>{null!=capturer&&(capturer.stop(),capturer_custom_save())}),5e3)):null!=capturer&&(capturer.stop(),capturer_custom_save());else if(70===e.keyCode)light_framerate_change=findNextValueByValue(light_framerate_change,light_frame_speed_param),console.log("light framerate changed to: "+getKeyByValue(light_frame_speed_param,light_framerate_change));else if(84===e.keyCode)base_light_angle_step=findNextValueByValue(base_light_angle_step,light_step_size_param),console.log("light angle step changed to: "+getKeyByValue(light_step_size_param,base_light_angle_step));else if(65===e.keyCode)light_angle+=Math.PI/6,console.log("Skipped 30degrees");else if(66===e.keyCode)(background_toggle=!background_toggle)?(document.body.style.backgroundColor="black",console.log("Background: black")):(document.body.style.backgroundColor="white",console.log("Background: white"));else if(69===e.keyCode)animation_frametime=0;else if(73===e.keyCode&&!e.ctrlKey){var t;document.getElementById("keybinding").style.display="block",document.querySelector("#keybinding").style.opacity=1,void 0!==t&&clearInterval(t),setTimeout((function(){t=setInterval((function(){document.querySelector("#keybinding").style.opacity-=.025,document.querySelector("#keybinding").style.opacity<=0&&(document.querySelector("#keybinding").style.display="none",clearInterval(t))}),100)}),3e3)}}View.prototype.addDenseMatter=function(){for(e in chosen_palette)elements_per_palette_object[chosen_palette[e]]=0,imesh_index_tracker[chosen_palette[e]]=0;for(var e=0;e<grid_nr_x;e++)for(var t=0;t<grid_nr_y;t++)for(var n=0;n<grid_nr_z;n++){var a=color_gradient_default,o=0;e>grid_nr_x/quadrant_div_x&&t>grid_nr_y/quadrant_div_y&&1==quadrants?(a=color_gradient_quadrants[0],o=0):e<grid_nr_x/quadrant_div_x&&t>grid_nr_y/quadrant_div_y&&1==quadrants?(a=color_gradient_quadrants[1],o=0):e>grid_nr_x/quadrant_div_x&&t<grid_nr_y/quadrant_div_y&&1==quadrants?(a=color_gradient_quadrants[2],o=0):1==quadrants&&(a=color_gradient_quadrants[3],o=0);var r,i=!1;color_features.includes("vertical stripe sparse")&&Math.floor(e/stripe_param_a)%stripe_param_b==e%stripe_param_c&&(a="width stack",o=0,i=!0),color_features.includes("vertical stripe dashed")&&Math.floor(e/stripe_width)%stripe_spacing==stripe_shift&&(a="width stack",o=10*shift_sign_vert,i=!0),color_features.includes("vertical stripe blocks")&&Math.floor(e/stripe_width)%stripe_spacing==stripe_shift&&(a="height stack",o=10*shift_sign_vert,i=!0),color_features.includes("vertical stripe solid")&&Math.floor(e/stripe_width)%stripe_spacing==stripe_shift&&(a="depth stack",o=10*shift_sign_vert,i=!0),color_features.includes("horizontal stripe dashed")&&t%stripe_spacing==stripe_shift&&(a="width stack",o=10*shift_sign_horiz,i=!0),color_features.includes("horizontal stripe solid")&&t%stripe_spacing==stripe_shift&&(a="height stack",o=10*shift_sign_horiz,i=!0),color_features.includes("horizontal stripe blocks")&&t%stripe_spacing==stripe_shift&&e%block_spacing>block_spacing/2&&e%block_spacing<=block_width+block_spacing/2&&(a="height stack",o=10*shift_sign_horiz,i=!0),r="solid"==a?[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]:"solid sprinkled"==a?[50,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]:"uniform"==a?chosen_palette.length>4?[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1]:[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]:"vertical grading"==a?[t,grid_nr_y-t,1,1,1,1,1,1,1,1,1,1,1,1,1]:"horizontal grading"==a?[e,grid_nr_x-e,1,1,1,1,1,1,1,1,1,1,1,1,1]:"vertical grading clean"==a?[t,grid_nr_y-t,0,0,0,0,0,0,0,0,0,0,0,0,0]:"horizontal grading clean"==a?[e,grid_nr_x-e,0,0,0,0,0,0,0,0,0,0,0,0,0]:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(var s=[],c=0;c<chosen_palette.length;c++){var l=(c+n)%chosen_palette.length;s.push([chosen_palette[c],r[l]])}if("solid"==a||"solid sprinkled"==a||"uniform"==a||"vertical grading"==a||"horizontal grading"==a||"vertical grading clean"==a||"horizontal grading clean"==a)var _=gene_weighted_choice(s);else if("width stack"==a){var d=e%chosen_palette.length;_=chosen_palette[d]}else if("height stack"==a)d=(t+n)%chosen_palette.length,_=chosen_palette[d];else if("depth stack"==a)d=n%chosen_palette.length,_=chosen_palette[d];var g,p=perlin3D(e*noise_scale_x+noise_shift_x,t*noise_scale_y*noise_height_f+noise_shift_y,n*noise_scale_z+noise_shift_z);"fuzzy"==noise_cull_rule?g=gene():"clean"==noise_cull_rule&&(g=.5);var f=!(g<p),h=new THREE.Vector3(e*(c_xy_scale+x_gap)+grid_offset_x,t*(c_length+y_gap)+grid_offset_y,n*(c_xy_scale+x_gap)+grid_offset_z+o),m=new THREE.Vector3(e,t,n),u=m.x.toString()+" "+m.y.toString()+" "+m.z.toString();if(1==f){var w=elements_per_palette_object[_];elements_per_palette_object[_]+=1}else _=void 0,w=void 0;var y={exists:f,position:h,dist_to_ctr:null,exp_vectors:null,str_perturbance:null,rotation_gene:null,grid_pos:m,color:_,smooth:i,base_matrix:null,imesh_idx:w};dense_matter_object[u]=y}for(const[t,n]of Object.entries(elements_per_palette_object)){var v=new THREE.Color(t),b=new THREE.CylinderGeometry(cylinder_params[c_type][0],cylinder_params[c_type][1],cylinder_params[c_type][2],cylinder_params[c_type][3],cylinder_params[c_type][4],!1),x=new THREE.MeshPhongMaterial({flatShading:!0}),M=["attribute vec3 instanceColor;","varying vec3 vInstanceColor;","#include <common>"].join("\n"),E=["#include <begin_vertex>","\tvInstanceColor = instanceColor;"].join("\n"),k=["varying vec3 vInstanceColor;","#include <common>"].join("\n"),H=["vec4 diffuseColor = vec4( diffuse * vInstanceColor, opacity );"].join("\n");x.onBeforeCompile=function(e){e.vertexShader=e.vertexShader.replace("#include <common>",M).replace("#include <begin_vertex>",E),e.fragmentShader=e.fragmentShader.replace("#include <common>",k).replace("vec4 diffuseColor = vec4( diffuse, opacity );",H)};var T=new THREE.InstancedMesh(b,x,n),R=[];for(e=0;e<T.count;e++)R.push(v.r),R.push(v.g),R.push(v.b);var z=new Float32Array(R.length);z.set(R),b.setAttribute("instanceColor",new THREE.InstancedBufferAttribute(new Float32Array(R),3)),b.setAttribute("instanceColorBase",new THREE.BufferAttribute(new Float32Array(z),3)),imeshes_object[t]=T,total_elements_existing+=n}console.log("%cQUANTITY","color: white; background: #000000;"),console.log("existing elements ->",total_elements_existing),console.log("density ->",Math.round(100*total_elements_existing/total_possible_elements),"%");var P=new THREE.Vector3(0,0,1),C=new THREE.Vector3(1,0,0),S=new THREE.Vector3(0,0,1);for(const[e,t]of Object.entries(dense_matter_object))if(0!=t.exists){var q=new THREE.Object3D;(T=imeshes_object[t.color]).instanceMatrix.setUsage(THREE.DynamicDrawUsage),T.frustumCulled=!1;h=t.position;if(q.scale.set(c_xy_scale,c_length,c_xy_scale),q.quaternion.setFromUnitVectors(P,S.clone().normalize()),q.position.set(h.x,h.y,h.z),0==t.smooth)var I=[.25*jitter_reduction,.15*jitter_reduction];else I=[0,0];q.rotateY(.28*Math.PI+(gene()-.5)*I[0]),q.rotateOnWorldAxis(C,(gene()-.5)*I[1]),q.updateMatrix(),t.base_matrix=q.matrix,T.setMatrixAt(imesh_index_tracker[t.color],q.matrix),imesh_index_tracker[t.color]+=1}console.log(explosion_center_a),View.prototype.DenseMatterCreateExplosionVectors(explosion_center_a);var j=[];for(const[e,t]of Object.entries(imeshes_object))t.rotateX(global_rot_x),t.rotateY(global_rot_y),t.instanceMatrix.needsUpdate=!0,t.castShadow=!0,t.receiveShadow=!0,t.name=e,this.scene.add(t),j.push(t);var A=[];for(console.log(chosen_palette),e=0;e<chosen_palette.length;e++){var V=new THREE.Color(chosen_palette[e]);console.log(V),A.push(V)}var D=shiftArrayCopy(A),W=0;const O=c_xy_scale*grid_nr_x;if(null==palette_state_t)setInterval((function(){if(W<=2e3){var e=0,t=W/2e3;for(const[o,r]of Object.entries(imeshes_object)){var n;for(let o=0;o<r.count;o++){let r=new THREE.Matrix4;j[e].getMatrixAt(o,r);var a=r.elements[12]/O+.5;n=t-(a*=1-t)>gene()?D[e]:A[e],j[e].geometry.attributes.instanceColor.setXYZ(o,n.r,n.g,n.b)}j[e].geometry.attributes.instanceColor.needsUpdate=!0,e++}}(W+=100)>=5e3&&(A=[...D],D=shiftArrayCopy(A),W=0)}),100);else for(let e=0;e<palette_state_t%D.length;e++){A=[...D],D=shiftArrayCopy(A);n=0;for(const[e,t]of Object.entries(imeshes_object)){var U;for(let e=0;e<t.count;e++){let t=new THREE.Matrix4;j[n].getMatrixAt(e,t);t.elements[12];U=A[n],j[n].geometry.attributes.instanceColor.setXYZ(e,U.r,U.g,U.b)}j[n].geometry.attributes.instanceColor.needsUpdate=!0,n++}}},View.prototype.DenseMatterCreateExplosionVectors=function(e){for(const[o,r]of Object.entries(dense_matter_object))if(0!=r.exists){var t=r.position;r.rotation_gene={x:gene(),y:gene(),z:gene()},r.dist_to_ctr=t.distanceTo(e),r.str_perturbance=gene_range(.5,1);var n=new THREE.Vector3(gene_range(-1,1),gene_range(-1,1),gene_range(-1,1)).multiplyScalar(.2),a=(new THREE.Vector3).subVectors(t,e).normalize().add(n);r.exp_vector=a}},View.prototype.DenseMatterUpdateT=function(e){dense_matter_memory[e]={};for(const[r,i]of Object.entries(dense_matter_object))if(0!=i.exists){var t=new THREE.Object3D,n=i.exp_vector,a=i.dist_to_ctr;t.applyMatrix4(i.base_matrix);var o=i.str_perturbance;t.translateOnAxis(n,o*e*explosion_strength/Math.pow(a,2)),t.rotateX(e*explosion_strength*explosion_rot_factor*(i.rotation_gene.x*explosion_rot_range*2-explosion_rot_range)/Math.pow(a,3)),t.rotateY(e*explosion_strength*explosion_rot_factor*(i.rotation_gene.y*explosion_rot_range*2-explosion_rot_range)/Math.pow(a,3)),t.rotateZ(e*explosion_strength*explosion_rot_factor*(i.rotation_gene.z*explosion_rot_range*2-explosion_rot_range)/Math.pow(a,3)),t.updateMatrix(),dense_matter_memory[e][r]=t.matrix}},View.prototype.DenseMatterUpdateFromMemory=function(e){for(const[n,a]of Object.entries(dense_matter_object))if(0!=a.exists){var t=a.imesh_idx;imeshes_object[a.color].setMatrixAt(t,dense_matter_memory[e][n])}for(const[e,t]of Object.entries(imeshes_object))t.instanceMatrix.needsUpdate=!0},View.prototype.addStarsRandom=function(e,t){const n=new THREE.PolyhedronGeometry([0,1,0,1,0,0,-1,0,0],[2,1,0],.3,0);n.scale(1,1.5,1);const a=new THREE.MeshPhongMaterial({color:16777215}),o=new THREE.InstancedMesh(n,a,t);o.instanceMatrix.setUsage(THREE.DynamicDrawUsage);for(var r=0;r<t;r++){const t=new THREE.Object3D;var i=.5+gene();t.scale.set(i,i,i),t.position.set(gene()*e-e/2,gene()*e-e/2,-2e3),t.rotateX(gene()*Math.PI/3-Math.PI/6),t.rotateY(gene()*Math.PI/3-Math.PI/6),t.rotateZ(gene()*Math.PI/3-Math.PI/6),t.updateMatrix(),o.setMatrixAt(r,t.matrix)}o.instanceMatrix.needsUpdate=!0,this.scene.add(o)},View.prototype.addStarDust=function(){for(var e=5,t=100,n=[],a=0;a<20;a++){var o=new THREE.Vector3(gene_range(-100,t),gene_range(-100,t),-2e3);n.push(o.clone()),e*=.95;for(var r=a%2*.5/Math.sqrt(a+1),i=-(a+1)%2*.5/Math.sqrt(a+1),s=0;s<4e3;s++){var c=new THREE.Vector3(gene_range(-e,e),gene_range(-e+r,e+i),0),l=o.clone();l.add(c),n.push(l),o=l.clone()}}const _=new THREE.PolyhedronGeometry([0,1,0,1,0,0,-1,0,0],[2,1,0],.3,0);_.scale(1,1.5,1);const d=new THREE.MeshPhongMaterial({color:16777215}),g=new THREE.InstancedMesh(_,d,8e4);g.instanceMatrix.setUsage(THREE.DynamicDrawUsage);for(s=0;s<n.length;s++){const e=new THREE.Object3D;var p=0+gene();e.scale.set(p,p,p),e.position.set(n[s].x,n[s].y,-2e3),e.rotateX(gene()*Math.PI/3-Math.PI/6),e.rotateY(gene()*Math.PI/3-Math.PI/6),e.rotateZ(gene()*Math.PI/3-Math.PI/6),e.updateMatrix(),g.setMatrixAt(s,e.matrix)}g.instanceMatrix.needsUpdate=!0,this.scene.add(g)},View.prototype.addMoon=function(){var e,t,n,a,o,r,i,s,c,l,_,d,g,p,f,h,m,u,w;n=gene_range(5,50),i=gene_range(-100,100),s=gene_range(-100,100),e=50,t=50,a=[],u=[],_=[],d=[],h=generateRandomInt(1,10),m=gene_range(150,300);for(var y=0;y<h;y++)_.push(gene_range(-m,m)),d.push(gene_range(-m,m)),a.push(gene_range(.05,.95)),w=gene()<.25,u.push(w);f=1e3*h;const v=new THREE.CircleGeometry(n,128),b=new THREE.MeshBasicMaterial({color:"#f9f0de"}),x=new THREE.Mesh(v,b);x.position.set(i,s,-1900);const M=new THREE.PolyhedronGeometry([0,1,0,1,0,0,-1,0,0],[2,1,0],.3,0);M.scale(1,1.5,1);const E=new THREE.MeshPhongMaterial({color:16777215}),k=new THREE.InstancedMesh(M,E,f);k.instanceMatrix.setUsage(THREE.DynamicDrawUsage);for(y=0;y<f;y++){rand_idx=generateRandomInt(0,_.length),g=gene_range(0,2*Math.PI),p=gene_range(0,gene_range(0,gene_range(0,gene_range(0,gene_range(0,1))))),o=_[rand_idx],r=d[rand_idx],1==u[rand_idx]?(gene()<.5?(e=2.5*a[rand_idx],t=50*a[rand_idx]*5):(e=50*a[rand_idx]*5,t=2.5*a[rand_idx]),gene()<.25&&(e=50*a[rand_idx],t=50*a[rand_idx])):(e=50*a[rand_idx]*.25,t=50*a[rand_idx]*.25),c=o+p*e*Math.cos(g)*Math.cos(0)-p*t*Math.sin(g)*Math.sin(0),l=r+p*e*Math.cos(g)*Math.sin(0)+p*t*Math.sin(g)*Math.cos(0);const n=new THREE.Object3D;var H=.5+gene();n.scale.set(H,H,H),n.position.set(c,l,-1800),n.rotateX(gene()*Math.PI/3-Math.PI/6),n.rotateY(gene()*Math.PI/3-Math.PI/6),n.rotateZ(gene()*Math.PI/3-Math.PI/6),n.updateMatrix(),Math.max(Math.abs(c),Math.abs(l))<1e3&&k.setMatrixAt(y,n.matrix)}k.instanceMatrix.needsUpdate=!0,setInterval((function(){k.rotateZ(rotThetaDelta),x.applyMatrix4(rotMatrixStaticIncrement)}),100),this.scene.add(x),this.scene.add(k)},View.prototype.preRender=function(){dense_matter_memory={};for(let e=0;e<5;e+=.25)e<5&&View.prototype.DenseMatterUpdateT(e)},View.prototype.render=function(){if(null!=explosion_state_t&&(animation_frametime=explosion_state_t),animation_frametime<5&&View.prototype.DenseMatterUpdateFromMemory(animation_frametime),debug)var e=(new Date).getTime();if(this.composer.render(),requestAnimationFrame(this.render.bind(this)),animation_frametime<5&&(animation_frametime+=.25),debug){var t=(new Date).getTime();composer_pass=t-e}snap&&(capture(controller),snap=!1),recording&&capturer.capture(renderer.domElement)};const handler=e=>{obscvrvm()},capture=e=>{document.documentElement.scrollWidth=viewportWidth*quality,document.documentElement.scrollHeight=viewportHeight*quality,cam_factor_mod=cam_factor*Math.min(viewportWidth*quality/1e3,viewportHeight*quality/1e3),document.getElementById("viewport").style.marginTop="0px",document.getElementById("viewport").style.marginLeft="0px",fitCameraToViewport(e.view,viewportWidth*quality,viewportHeight*quality,!0),composer.render();try{const e=renderer.domElement.toDataURL("img/png"),t=document.createElement("a");t.href=e,t.download=`tectonica_${palette_name}_${parseInt(1e7*Math.random())}.png`,t.click(),URL.revokeObjectURL(e)}catch(e){return void console.log("Browser does not support taking screenshot of 3d context")}quality=1,viewportAdjust(document.getElementById("viewport")),cam_factor_mod=cam_factor*Math.min(viewportWidth*quality/1e3,viewportHeight*quality/1e3),fitCameraToViewport(e.view,viewportWidth,viewportHeight),composer.render()};document.addEventListener("keyup",doc_keyUp,!1),document.addEventListener("DOMContentLoaded",(()=>{obscvrvm()}));